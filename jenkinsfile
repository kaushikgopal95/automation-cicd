pipeline {
    agent any

    environment {
        STAGING_URL = 'https://stag-plantbot.netlify.app/'
        PRODUCTION_URL = 'https://prod-plantbot.netlify.app/'
        BUILD_TIMESTAMP = "${new Date().format('yyyyMMdd-HHmmss')}"
        RECIPIENTS = 'kaushik.gopal95@gmail.com'
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        retry(1)
        timestamps()
    }

    stages {
        stage('Wait for Staging Deployment') {
            steps {
                script {
                    def stagingUrl = env.STAGING_URL.trim()
                    bat "echo Waiting for staging deployment at ${stagingUrl}"
                    bat "node scripts/wait-for-healthy.js ${stagingUrl} 60"
                    bat "curl -I ${stagingUrl}"
                }
                echo "Staging deployment completed and healthy"
            }
        }

        stage('Run Cypress Tests on Staging') {
            steps {
                withCredentials([string(credentialsId: 'cypress-record-key', variable: 'CYPRESS_RECORD_KEY')]) {
                    bat 'npm install'
                    script {
                        def stagingUrl = env.STAGING_URL.trim()
                        def cypressOutput = bat(
                            script: "set CYPRESS_BASE_URL=${stagingUrl}&& npx cypress.run --record --key %CYPRESS_RECORD_KEY% --browser chrome",
                            returnStdout: true
                        ).trim()

                        def totalTests = 0
                        def passedTests = 0
                        def failedTests = 0
                        def dashboardUrl = ""

                        cypressOutput.split('\n').each { line ->
                            if (line.contains('passing')) {
                                def matcher = line =~ /(\d+)\s+passing/
                                if (matcher.find()) {
                                    passedTests = matcher[0][1] as Integer
                                }
                            }
                            if (line.contains('failing')) {
                                def matcher = line =~ /(\d+)\s+failing/
                                if (matcher.find()) {
                                    failedTests = matcher[0][1] as Integer
                                }
                            }
                            if (line.contains('https://dashboard.cypress.io/projects/')) {
                                def matcher = line =~ /(https:\/\/dashboard\.cypress\.io\/projects\/[^\s]+)/
                                if (matcher.find()) {
                                    dashboardUrl = matcher[0][1]
                                }
                            }
                        }

                        totalTests = passedTests + failedTests

                        env.CYPRESS_STATS = "Total: ${totalTests} | Passed: ${passedTests} | Failed: ${failedTests}"
                        env.CYPRESS_DASHBOARD_URL = dashboardUrl ?: "Check Cypress Dashboard"

                        echo "Cypress Test Results: ${env.CYPRESS_STATS}"
                        echo "Dashboard URL: ${env.CYPRESS_DASHBOARD_URL}"
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'cypress/videos/**/*,cypress/screenshots/**/*,cypress/results/**/*', allowEmptyArchive: true
                }
            }
        }

      }
    }
    
    stage('Create PR from Staging to Main') {
      when {
        expression { currentBuild.currentResult == 'SUCCESS' }
      }
      steps {

        withCredentials([string(credentialsId: 'github-credentials', variable: 'GITHUB_TOKEN')]) {
          bat """curl -X POST -H "Authorization: token %GITHUB_TOKEN%" -d "{\\"title\\":\\"Auto PR: Merge Staging into Main\\",\\"head\\":\\"staging\\",\\"base\\":\\"main\\"}" https://api.github.com/repos/kaushikgopal95/automation-cicd/pulls"""


        }
    }

    post {
        always {
            echo "Pipeline completed with status: ${currentBuild.currentResult}"
            echo "Email recipients: ${RECIPIENTS}"
            echo "Test Results: ${env.CYPRESS_STATS}"
        }

        success {
            emailext (
                subject: "Pipeline SUCCESS - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                mimeType: 'text/html',
                body: """
                <h2>Pipeline Successful!</h2>
                <p>PR has been created from <strong>staging â†’ main</strong>.</p>
                <p><a href="https://github.com/kaushikgopal95/automation-cicd/pulls">Review Pull Requests</a></p>
                <p><strong>Staging URL:</strong> ${STAGING_URL}</p>
                """,
                to: "${RECIPIENTS}"
            )
        }

        failure {
            emailext (
                subject: "Pipeline FAILED - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                mimeType: 'text/html',
                body: """
                <h2>Pipeline Failed!</h2>
                <p><strong>Project:</strong> ${env.JOB_NAME}</p>
                <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
                <p><strong>Status:</strong> <span style="color: red;">FAILED</span></p>
                <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
                <h3>Action Required</h3>
                <p>Please check failing Cypress tests and logs.</p>
                <p><a href="https://github.com/kaushikgopal95/automation-cicd">GitHub Repository</a></p>
                """,
                to: "${RECIPIENTS}"
            )
        }

        unstable {
            emailext (
                subject: "Pipeline UNSTABLE - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                mimeType: 'text/html',
                body: """
                <h2>Pipeline Unstable!</h2>
                <p><strong>Project:</strong> ${env.JOB_NAME}</p>
                <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
                <p><strong>Status:</strong> <span style="color: orange;">UNSTABLE</span></p>
                <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
                <p>Please review flaky or failed tests.</p>
                <p><a href="https://github.com/kaushikgopal95/automation-cicd">GitHub Repository</a></p>
                """,
                to: "${RECIPIENTS}"
            )
        }
    }
}
