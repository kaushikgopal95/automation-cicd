pipeline {
    agent any

    environment {
        STAGING_URL = 'https://stag-plantbot.netlify.app'
        PRODUCTION_URL = 'https://prod-plantbot.netlify.app/'
        BUILD_TIMESTAMP = "${new Date().format('yyyyMMdd-HHmmss')}"
        RECIPIENTS = 'kaushik.gopal95@gmail.com'
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        retry(1)
        timestamps()
    }

    stages {
        stage('Wait for Staging Deployment') {
            steps {
                bat "echo Waiting for staging deployment at %STAGING_URL%"
                bat "node scripts/wait-for-healthy.js %STAGING_URL% 60"
                bat "curl -I %STAGING_URL%"
                echo "Staging deployment completed and healthy"
            }
        }

        stage('Run Cypress Tests on Staging') {
            steps {
                withCredentials([string(credentialsId: 'cypress-record-key', variable: 'CYPRESS_RECORD_KEY')]) {
                    bat 'npm install'
                    bat "set CYPRESS_BASE_URL=%STAGING_URL:~0,-0% && npx cypress run --record --key %CYPRESS_RECORD_KEY% --browser chrome"
                    echo "Cypress tests executed and recorded to Cypress Dashboard"
                }
            }
            post {
                always {
                    script {
                        try {
                            archiveArtifacts artifacts: 'cypress/videos/**/*,cypress/screenshots/**/*,cypress/results/**/*', allowEmptyArchive: true
                        } catch (Exception e) {
                            echo "No Cypress artifacts found: ${e.getMessage()}"
                        }
                    }
                }
            }
        }

        stage('Create PR from Staging to Main') {
            when {
                expression { currentBuild.currentResult == 'SUCCESS' }
            }
            steps {
                withCredentials([string(credentialsId: 'github-credentials', variable: 'GITHUB_TOKEN')]) {
                    bat """curl -X POST -H "Authorization: token %GITHUB_TOKEN%" -d "{\\"title\\":\\"Auto PR: Merge Staging into Main\\",\\"head\\":\\"staging\\",\\"base\\":\\"main\\"}" https://api.github.com/repos/kaushikgopal95/automation-cicd/pulls"""
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline completed with status: ${currentBuild.currentResult}"
            echo "Email recipients: ${RECIPIENTS}"
            echo "Build URL: ${env.BUILD_URL}"
        }

        success {
            script {
                try {
                    echo "Sending success email to: ${RECIPIENTS}"
                    emailext (
                        subject: "Pipeline SUCCESS - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: """
                        Pipeline completed successfully!

                        Staging deployment is done and Cypress tests passed.
                        PR has been created from staging â†’ main. Please review and merge:
                        https://github.com/kaushikgopal95/automation-cicd/pulls

                        Staging URL: ${STAGING_URL}
                        Build logs: ${env.BUILD_URL}
                        """,
                        to: "${RECIPIENTS}"
                    )
                    echo "Success email sent"
                } catch (Exception e) {
                    echo "Failed to send success email: ${e.getMessage()}"
                }
            }
        }

        failure {
            script {
                try {
                    echo "Sending failure email to: ${RECIPIENTS}"
                    emailext (
                        subject: "Pipeline FAILED - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: """
                        <h2>Pipeline Failed!</h2>
                        <p><strong>Project:</strong> ${env.JOB_NAME}</p>
                        <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
                        <p><strong>Status:</strong> <span style="color: red;">FAILED</span></p>
                        <p><strong>Duration:</strong> ${currentBuild.durationString}</p>

                        <h3>Links</h3>
                        <p><strong>Build Console:</strong> <a href="${env.BUILD_URL}">View Build Logs</a></p>
                        <p><strong>GitHub Repository:</strong> <a href="https://github.com/kaushikgopal95/automation-cicd">View Repository</a></p>

                        <p><strong>Action Required:</strong> Please check the build logs and fix the issues.</p>
                        """,
                        to: "${RECIPIENTS}",
                        mimeType: 'text/html',
                        from: 'jenkins@automation-cicd.com'
                    )
                    echo "Failure email sent"
                } catch (Exception e) {
                    echo "Failed to send failure email: ${e.getMessage()}"
                }
            }
        }

        unstable {
            script {
                try {
                    echo "Sending unstable email to: ${RECIPIENTS}"
                    emailext (
                        subject: "Pipeline UNSTABLE - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: """
                        <h2>Pipeline Unstable!</h2>
                        <p><strong>Project:</strong> ${env.JOB_NAME}</p>
                        <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
                        <p><strong>Status:</strong> <span style="color: orange;">UNSTABLE</span></p>
                        <p><strong>Duration:</strong> ${currentBuild.durationString}</p>

                        <h3>Links</h3>
                        <p><strong>Build Console:</strong> <a href="${env.BUILD_URL}">View Build Logs</a></p>
                        <p><strong>GitHub Repository:</strong> <a href="https://github.com/kaushikgopal95/automation-cicd">View Repository</a></p>

                        <p><strong>Action Required:</strong> Please review the build logs for warnings or issues.</p>
                        """,
                        to: "${RECIPIENTS}",
                        mimeType: 'text/html',
                        from: 'jenkins@automation-cicd.com'
                    )
                    echo "Unstable email sent"
                } catch (Exception e) {
                    echo "Failed to send unstable email: ${e.getMessage()}"
                }
            }
        }
    }
}
