pipeline {
  agent any
  
  environment {
    STAGING_URL = 'https://stag-plantbot.netlify.app'
    PRODUCTION_URL = 'https://prod-plantbot.netlify.app/'
    BUILD_TIMESTAMP = "${new Date().format('yyyyMMdd-HHmmss')}"
    RECIPIENTS = 'kaushik.gopal95@gmail.com'
  }
  
  def getCypressResults() {
    try {
      def resultsFile = readFile('cypress/results/results.json')
      def results = readJSON text: resultsFile
      return [
        totalTests: results.stats.tests,
        passed: results.stats.passes,
        failed: results.stats.failures,
        skipped: results.stats.pending,
        duration: results.stats.duration
      ]
    } catch (Exception e) {
      echo "Could not read Cypress results: ${e.getMessage()}"
      return [totalTests: 0, passed: 0, failed: 0, skipped: 0, duration: 0]
    }
  }
  
  def getFailureReason() {
    if (currentBuild.currentResult == 'FAILURE') {
      if (env.STAGE_NAME == 'Run Cypress Tests on Staging') {
        return "Cypress tests failed on staging environment"
      } else if (env.STAGE_NAME == 'Promote to Main Branch') {
        return "Failed to merge staging branch to main - Git push failed"
      } else if (env.STAGE_NAME == 'Wait for Staging Deployment') {
        return "Staging deployment health check failed or timed out"
      } else if (env.STAGE_NAME == 'Wait for Production Deployment') {
        return "Production deployment health check failed or timed out"
      }
    }
    return "Unknown failure reason"
  }
  
  options {
    timeout(time: 30, unit: 'MINUTES')
    retry(1)
    timestamps()
  }
  
  stages {
    // stage('Deploy to Staging') {
    //   steps {
    //     bat 'curl -X POST -d {} "https://api.netlify.com/build_hooks/68b18e4052945d72b87627f4"'
    //     echo "Netlify staging deployment triggered"
    //   }
    // }
    
    stage('Wait for Staging Deployment') {
      steps {
        bat "echo Waiting for staging deployment at %STAGING_URL%"
        bat "node scripts/wait-for-healthy.js %STAGING_URL% 60"
        bat "curl -I %STAGING_URL%"
        echo "Staging deployment completed and healthy"
      }
    }
    
    stage('Run Cypress Tests on Staging') {
      steps {
        bat 'npm install'
        bat "set CYPRESS_BASE_URL=%STAGING_URL% && npx cypress run --reporter json --reporter-options output=cypress/results/results.json"
        echo "Build status after Cypress: ${currentBuild.currentResult}"
      }
      post {
        always {
          script {
            try {
              archiveArtifacts artifacts: 'cypress/videos/**/*,cypress/screenshots/**/*,cypress/results/**/*', allowEmptyArchive: true
            } catch (Exception e) {
              echo "No Cypress artifacts found: ${e.getMessage()}"
            }
          }
        }
      }
    }
    
    stage('Promote to Main Branch') {
      when {
        expression { currentBuild.currentResult == 'SUCCESS' }
      }
      steps {
        echo "Tests passed, promoting staging to main branch"
        
        withCredentials([string(credentialsId: 'github-credentials', variable: 'GIT_TOKEN')]) {
          bat '''
            echo "=== Using HTTPS with PAT to merge staging to main ==="

            git config user.name "kaushikgopal95"
            git config user.email "kaushikgopal95@users.noreply.github.com"

            REM Disable interactive prompts
            git config --global credential.helper ""
            set GIT_ASKPASS=echo


            REM Set remote URL using PAT (x-access-token format)

            git remote set-url origin https://x-access-token:%GIT_TOKEN%@github.com/kaushikgopal95/automation-cicd.git
            bat 'echo Remote URL: https://x-access-token:***@github.com/kaushikgopal95/automation-cicd.git'

            REM Rebase and merge staging into main
            git fetch origin main
            git checkout main

            git pull origin main --rebase || echo "Rebase skipped - proceeding with merge"
            git merge origin/staging --no-edit

            REM Push changes
            git push origin main
            if %ERRORLEVEL% neq 0 (
              echo "Git push failed with error code: %ERRORLEVEL%"
              exit /b 1
            )
          '''
        }
        
        echo "Successfully promoted staging branch to main"
      }
    }
    
    stage('Wait for Production Deployment') {
      when {
        expression { currentBuild.currentResult == 'SUCCESS' }
      }
      steps {
        echo "Proceeding with production deployment"
        bat 'echo "Main branch updated - Netlify will auto-deploy to production"'
        bat "node scripts/wait-for-healthy.js %PRODUCTION_URL% 300"
        echo "Production deployment completed and healthy"
      }
      post {
        success {
          echo "Production deployment successful! Pipeline completed successfully."
        }
      }
    }
  }
  
  post {
    always {
      echo "Pipeline completed with status: ${currentBuild.currentResult}"
      echo "Email recipients: ${RECIPIENTS}"
      echo "Build URL: ${env.BUILD_URL}"
    }
    
    success {
      script {
        try {
          echo "Attempting to send success email to: ${RECIPIENTS}"
          def cypressResults = getCypressResults()
          emailext (
            subject: "Pipeline SUCCESS - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
            body: """
            <h2>Pipeline Completed Successfully!</h2>
            <p><strong>Project:</strong> ${env.JOB_NAME}</p>
            <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
            <p><strong>Status:</strong> <span style="color: green;">SUCCESS</span></p>
            <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
            
            <h3>Test Results</h3>
            <table border="1" style="border-collapse: collapse; margin: 10px 0;">
              <tr><td><strong>Total Tests:</strong></td><td>${cypressResults.totalTests}</td></tr>
              <tr><td><strong>Passed:</strong></td><td style="color: green;">${cypressResults.passed}</td></tr>
              <tr><td><strong>Failed:</strong></td><td style="color: red;">${cypressResults.failed}</td></tr>
              <tr><td><strong>Skipped:</strong></td><td style="color: orange;">${cypressResults.skipped}</td></tr>
              <tr><td><strong>Test Duration:</strong></td><td>${cypressResults.duration}ms</td></tr>
            </table>
            
            <h3>Deployment URLs</h3>
            <p><strong>Staging URL:</strong> <a href="${STAGING_URL}">${STAGING_URL}</a></p>
            <p><strong>Production URL:</strong> <a href="${PRODUCTION_URL}">${PRODUCTION_URL}</a></p>
            
            <h3>Links</h3>
            <p><strong>Build Console:</strong> <a href="${env.BUILD_URL}">View Build Logs</a></p>
            <p><strong>GitHub Repository:</strong> <a href="https://github.com/kaushikgopal95/automation-cicd">View Repository</a></p>
            """,
            to: "${RECIPIENTS}",
            mimeType: 'text/html',
            from: 'jenkins@automation-cicd.com'
          )
          echo "Success email sent successfully"
        } catch (Exception e) {
          echo "Failed to send success email: ${e.getMessage()}"
        }
      }
    }
    
    failure {
      script {
        try {
          echo "Attempting to send failure email to: ${RECIPIENTS}"
          def cypressResults = getCypressResults()
          def failureReason = getFailureReason()
          emailext (
            subject: "Pipeline FAILED - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
            body: """
            <h2>Pipeline Failed!</h2>
            <p><strong>Project:</strong> ${env.JOB_NAME}</p>
            <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
            <p><strong>Status:</strong> <span style="color: red;">FAILED</span></p>
            <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
            
            <h3>Failure Reason</h3>
            <p style="color: red; font-weight: bold;">${failureReason}</p>
            
            <h3>Test Results</h3>
            <table border="1" style="border-collapse: collapse; margin: 10px 0;">
              <tr><td><strong>Total Tests:</strong></td><td>${cypressResults.totalTests}</td></tr>
              <tr><td><strong>Passed:</strong></td><td style="color: green;">${cypressResults.passed}</td></tr>
              <tr><td><strong>Failed:</strong></td><td style="color: red;">${cypressResults.failed}</td></tr>
              <tr><td><strong>Skipped:</strong></td><td style="color: orange;">${cypressResults.skipped}</td></tr>
              <tr><td><strong>Test Duration:</strong></td><td>${cypressResults.duration}ms</td></tr>
            </table>
            
            <h3>Links</h3>
            <p><strong>Build Console:</strong> <a href="${env.BUILD_URL}">View Build Logs</a></p>
            <p><strong>GitHub Repository:</strong> <a href="https://github.com/kaushikgopal95/automation-cicd">View Repository</a></p>
            
            <p><strong>Action Required:</strong> Please check the build logs and fix the issues.</p>
            """,
            to: "${RECIPIENTS}",
            mimeType: 'text/html',
            from: 'jenkins@automation-cicd.com'
          )
          echo "Failure email sent successfully"
        } catch (Exception e) {
          echo "Failed to send failure email: ${e.getMessage()}"
        }
      }
    }
    
    unstable {
      script {
        try {
          echo "Attempting to send unstable email to: ${RECIPIENTS}"
          def cypressResults = getCypressResults()
          emailext (
            subject: "Pipeline UNSTABLE - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
            body: """
            <h2>Pipeline Unstable!</h2>
            <p><strong>Project:</strong> ${env.JOB_NAME}</p>
            <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
            <p><strong>Status:</strong> <span style="color: orange;">UNSTABLE</span></p>
            <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
            
            <h3>Test Results</h3>
            <table border="1" style="border-collapse: collapse; margin: 10px 0;">
              <tr><td><strong>Total Tests:</strong></td><td>${cypressResults.totalTests}</td></tr>
              <tr><td><strong>Passed:</strong></td><td style="color: green;">${cypressResults.passed}</td></tr>
              <tr><td><strong>Failed:</strong></td><td style="color: red;">${cypressResults.failed}</td></tr>
              <tr><td><strong>Skipped:</strong></td><td style="color: orange;">${cypressResults.skipped}</td></tr>
              <tr><td><strong>Test Duration:</strong></td><td>${cypressResults.duration}ms</td></tr>
            </table>
            
            <h3>Links</h3>
            <p><strong>Build Console:</strong> <a href="${env.BUILD_URL}">View Build Logs</a></p>
            <p><strong>GitHub Repository:</strong> <a href="https://github.com/kaushikgopal95/automation-cicd">View Repository</a></p>
            
            <p><strong>Action Required:</strong> Please review the build logs for warnings or issues.</p>
            """,
            to: "${RECIPIENTS}",
            mimeType: 'text/html',
            from: 'jenkins@automation-cicd.com'
          )
          echo "Unstable email sent successfully"
        } catch (Exception e) {
          echo "Failed to send unstable email: ${e.getMessage()}"
        }
      }
    }
  }
}
