pipeline {
  agent any
  
  environment {
    STAGING_URL = 'https://stag-plantbot.netlify.app'
    PRODUCTION_URL = 'https://prod-plantbot.netlify.app/'
    BUILD_TIMESTAMP = "${new Date().format('yyyyMMdd-HHmmss')}"
    RECIPIENTS = 'kaushi.kutty@gmail.com' // Add your email here
  }
  
  options {
    timeout(time: 30, unit: 'MINUTES')
    retry(1)
    timestamps()
  }
  
  stages {
    // stage('Deploy to Staging') {
    //   steps {
    //     script {
    //       // Trigger Netlify deployment using the build hook
    //       bat 'curl -X POST -d {} "https://api.netlify.com/build_hooks/68b18e4052945d72b87627f4"'
          
    //       echo "Netlify staging deployment triggered"
    //     }
    //   }
    // }
    
    stage('Wait for Staging Deployment') {
      steps {
        script {
          // Wait for staging deployment to be ready
          bat "echo Waiting for staging deployment at %STAGING_URL%"
          bat "echo Testing health check script..."
          
          // Test the health check script
          bat "node scripts/wait-for-healthy.js %STAGING_URL% 60"
          
          // Additional verification
          bat "echo Additional verification:"
          bat "curl -I %STAGING_URL%"
          
          echo "Staging deployment completed and healthy"
        }
      }
    }
    
    stage('Run Cypress Tests on Staging') {
      steps {
        script {
          // Install dependencies first
          bat 'npm install'
          
          // Run Cypress tests against the live staging URL
          bat "set CYPRESS_BASE_URL=%STAGING_URL% && npx cypress run"
          
          // Debug: Check build status
          echo "Current build result: ${currentBuild.result}"
          echo "Build status: ${currentBuild.currentResult}"
        }
      }
      post {
        always {
          // Archive Cypress artifacts if they exist
          script {
            try {
              archiveArtifacts artifacts: 'cypress/videos/**/*,cypress/screenshots/**/*', allowEmptyArchive: true
            } catch (Exception e) {
              echo "No Cypress artifacts found to archive: ${e.getMessage()}"
            }
          }
        }
      }
    }
    
    stage('Promote to Main Branch') {
      steps {
        script {
          echo "Current build result: ${currentBuild.result}"
          echo "Current build status: ${currentBuild.currentResult}"
          
          // Check if tests passed by looking at the previous stage result
          if (currentBuild.result == 'SUCCESS' || currentBuild.currentResult == 'SUCCESS') {
            echo "Tests passed, proceeding with promotion to main branch"
            
            // Configure Git credentials
            withCredentials([usernamePassword(credentialsId: 'github-credentials', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')]) {
              // Set Git configuration
              bat 'git config --global user.email "%GIT_USERNAME%@github.com"'
              bat 'git config --global user.name "%GIT_USERNAME%"'
              
              // Create PR for team review using PowerShell
              bat 'powershell -Command "git checkout main"'
              bat 'powershell -Command "git pull origin main"'
              
              // Check if there are changes to merge
              bat 'powershell -Command "git diff --quiet origin/staging; if ($LASTEXITCODE -ne 0) { Write-Host \'Changes detected between staging and main\' } else { Write-Host \'No changes to merge\' }"'
              
              // Create PR using GitHub API (more reliable than CLI)
              bat 'powershell -Command "$headers = @{\'Authorization\' = \'token %GIT_PASSWORD%\'; \'Accept\' = \'application/vnd.github.v3+json\'}; $body = @{title=\'Deploy to Production - %BUILD_TIMESTAMP%\'; head=\'staging\'; base=\'main\'; body=\'Automated deployment from staging. Tests passed successfully. Please review and merge to deploy to production.\'} | ConvertTo-Json; try { $response = Invoke-RestMethod -Uri \'https://api.github.com/repos/kaushikgopal95/automation-cicd/pulls\' -Method Post -Headers $headers -Body $body; Write-Host \'PR Created Successfully:\' $response.html_url } catch { Write-Error \'Failed to create PR:\' $_.Exception.Message; exit 1 }"'
              
              echo "Pull Request created successfully for team review"
            }
          } else {
            echo "Tests failed or build not successful, skipping promotion"
            currentBuild.result = 'FAILURE'
          }
        }
      }
    }
    
    stage('Wait for Production Deployment') {
      steps {
        script {
          echo "Current build result: ${currentBuild.result}"
          
          if (currentBuild.result == 'SUCCESS' || currentBuild.currentResult == 'SUCCESS') {
            echo "Proceeding with production deployment"
            
            // Trigger Netlify production deployment
            // bat 'curl -X POST -d {} "https://api.netlify.com/build_hooks/68b68850a4e373ee7b86e5fb"'
            
            // Wait for production deployment to be ready
            bat "node scripts/wait-for-healthy.js %PRODUCTION_URL% 300"
            
            echo "Production deployment completed and healthy"
          } else {
            echo "Skipping production deployment due to failed tests"
          }
        }
      }
      post {
        success {
          echo "Production deployment successful! Pipeline completed successfully."
        }
      }
    }
  }
  
  post {
    always {
      echo "Pipeline completed with status: ${currentBuild.result}"
    }
    
    success {
      emailext (
        subject: "Pipeline SUCCESS - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
        body: """
        <h2>Pipeline Completed Successfully!</h2>
        <p><strong>Project:</strong> ${env.JOB_NAME}</p>
        <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
        <p><strong>Status:</strong> <span style="color: green;">SUCCESS</span></p>
        <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
        <p><strong>Staging URL:</strong> <a href="${STAGING_URL}">${STAGING_URL}</a></p>
        <p><strong>Production URL:</strong> <a href="${PRODUCTION_URL}">${PRODUCTION_URL}</a></p>
        <p><strong>Build Console:</strong> <a href="${env.BUILD_URL}">View Build Logs</a></p>
        
        <h3>What happened:</h3>
        <ul>
          <li>‚úÖ Code deployed to staging</li>
          <li>‚úÖ Cypress tests passed</li>
          <li>üìã Pull Request created for team review</li>
        </ul>
        
        <h3>Next Steps:</h3>
        <ol>
          <li>Review the Pull Request on GitHub</li>
          <li>Check the staging deployment</li>
          <li>Merge the PR to deploy to production</li>
        </ol>
        
        <p><strong>GitHub Repository:</strong> <a href="https://github.com/kaushikgopal95/automation-cicd">View Repository</a></p>
        """,
        to: "${RECIPIENTS}",
        mimeType: 'text/html'
      )
    }
    
    failure {
      emailext (
        subject: "Pipeline FAILED - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
        body: """
        <h2>Pipeline Failed!</h2>
        <p><strong>Project:</strong> ${env.JOB_NAME}</p>
        <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
        <p><strong>Status:</strong> <span style="color: red;">FAILED</span></p>
        <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
        <p><strong>Build Console:</strong> <a href="${env.BUILD_URL}">View Build Logs</a></p>
        
        <h3>Possible Issues:</h3>
        <ul>
          <li>‚ùå Cypress tests failed</li>
          <li>‚ùå Staging deployment failed</li>
          <li>‚ùå Health check timeout</li>
          <li>‚ùå Git operations failed</li>
        </ul>
        
        <p><strong>Action Required:</strong> Please check the build logs and fix the issues.</p>
        """,
        to: "${RECIPIENTS}",
        mimeType: 'text/html'
      )
    }
    
    unstable {
      emailext (
        subject: "Pipeline UNSTABLE - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
        body: """
        <h2>Pipeline Unstable!</h2>
        <p><strong>Project:</strong> ${env.JOB_NAME}</p>
        <p><strong>Build Number:</strong> #${env.BUILD_NUMBER}</p>
        <p><strong>Status:</strong> <span style="color: orange;">UNSTABLE</span></p>
        <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
        <p><strong>Build Console:</strong> <a href="${env.BUILD_URL}">View Build Logs</a></p>
        
        <p><strong>Action Required:</strong> Please review the build logs for warnings or issues.</p>
        """,
        to: "${RECIPIENTS}",
        mimeType: 'text/html'
      )
    }
  }
}